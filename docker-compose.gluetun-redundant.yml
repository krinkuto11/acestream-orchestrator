# Docker Compose configuration for redundant VPN mode
# This setup provides high availability with two Gluetun VPN containers
# Automatic failover ensures zero downtime if one VPN fails
#
# Quick Start:
# 1. Copy .env.example to .env
# 2. Configure VPN credentials in this file (WIREGUARD_PRIVATE_KEY for both containers)
# 3. Set VPN_MODE=redundant in .env (or below in orchestrator environment)
# 4. Configure port ranges: GLUETUN_PORT_RANGE_1 and GLUETUN_PORT_RANGE_2
# 5. Run: docker-compose -f docker-compose.gluetun-redundant.yml up -d
# 6. Access dashboard at http://localhost:8000/panel
#
# Key configuration points:
# 1. Two Gluetun containers (gluetun1, gluetun2) with separate configurations
# 2. Each Gluetun has its own HTTP control server port (8001 external, 8002 external; both use :8001 internal)
# 3. Port ranges are split between VPNs for engine distribution
# 4. Engines are automatically distributed across both VPNs in round-robin fashion
# 5. If one VPN fails, traffic automatically routes to the healthy VPN

services:
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "19000-19499:19000-19499"      
      - "8001:8001"
    environment:
      - PGID=1000
      - PUID=1000
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=
      - VPN_PORT_FORWARDING=on
      - SERVER_COUNTRIES=Spain,France,Germany,Portugal
      - HTTP_CONTROL_SERVER_ADDRESS=:8001     
      - DOT=off
      - HEALTH_VPN_DURATION_INITIAL=120s
      - HEALTH_TARGET_ADDRESS=cloudflare.com:80
      - TZ=Europe/Madrid
    restart: unless-stopped
    networks:
      - aceserver

  gluetun2:
    image: qmcgaw/gluetun
    container_name: gluetun2
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "19500-19999:19500-19999"
      - "8002:8001"
    environment:
      - PGID=1000
      - PUID=1000
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=
      - VPN_PORT_FORWARDING=on
      - SERVER_COUNTRIES=Spain,France,Germany,Portugal
      - HTTP_CONTROL_SERVER_ADDRESS=:8001     
      - DOT=off
      - HEALTH_VPN_DURATION_INITIAL=120s
      - HEALTH_TARGET_ADDRESS=cloudflare.com:80
      - TZ=Europe/Madrid
    restart: unless-stopped
    networks:
      - aceserver

  orchestrator:
    privileged: true
    container_name: orchestrator
    image: ghcr.io/krinkuto11/acestream-orchestrator:v1.0.0
    env_file: .env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8000:8000"
    restart: on-failure
    depends_on:
      gluetun:
        condition: service_healthy
      gluetun2:
        condition: service_healthy
    networks:
      - aceserver


  acestream:
    name: aceserver
    driver: bridge
