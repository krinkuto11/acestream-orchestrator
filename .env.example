# Core
APP_PORT=8000
DOCKER_NETWORK="aceserver"
MIN_REPLICAS=10
MIN_FREE_REPLICAS=1  # Minimum number of free replicas to maintain (default: 1)
MAX_REPLICAS=50
CONTAINER_LABEL=orchestrator.managed=acestream
STARTUP_TIMEOUT_S=25
IDLE_TTL_S=600

# Redis Configuration (for stream multiplexing buffer)
# Redis is included in the Docker container by default
# Configure if you want to use an external Redis instance
# REDIS_HOST=127.0.0.1
# REDIS_PORT=6379
# REDIS_DB=0

# Stream Proxy Configuration (NEW - for multi-client multiplexing)
# Uses battle-tested ts_proxy architecture with Redis ring buffer
PROXY_CHUNK_SIZE=8192
PROXY_BUFFER_CHUNK_SIZE=1061472  # 188 * 5644 (~1MB) - aligned to TS packets
PROXY_BUFFER_TTL=60  # Chunk TTL in Redis (seconds)
PROXY_CLIENT_TTL=60  # Client record TTL (seconds)
PROXY_HEARTBEAT_INTERVAL=10  # Client heartbeat interval (seconds)
PROXY_CLEANUP_INTERVAL=60  # Session cleanup check interval (seconds)
PROXY_GRACE_PERIOD=5  # Grace period before stopping idle streams (seconds)
PROXY_INIT_TIMEOUT=30  # Stream initialization timeout (seconds)
PROXY_CONNECTION_TIMEOUT=10  # Engine connection timeout (seconds)
PROXY_GHOST_CLIENT_MULTIPLIER=5.0  # Multiplier for ghost client detection (heartbeat_interval * multiplier)
ORCHESTRATOR_URL=http://localhost:8000  # URL for sending stream events (optional, defaults to localhost)

# Proxy Stream Data Tolerance
# Configure how long to wait for initial data and how tolerant to be during streaming
# PROXY_INITIAL_DATA_WAIT_TIMEOUT: Maximum seconds to wait for initial data before streaming starts (default: 10)
# PROXY_INITIAL_DATA_CHECK_INTERVAL: Seconds between buffer checks during initial wait (default: 0.2)
# PROXY_NO_DATA_TIMEOUT_CHECKS: Number of consecutive empty checks before declaring stream ended (default: 30)
# PROXY_NO_DATA_CHECK_INTERVAL: Seconds between checks when no data is available (default: 0.1)
# Total no-data timeout = PROXY_NO_DATA_TIMEOUT_CHECKS * PROXY_NO_DATA_CHECK_INTERVAL (default: 3 seconds)
# PROXY_INITIAL_DATA_WAIT_TIMEOUT=10
# PROXY_INITIAL_DATA_CHECK_INTERVAL=0.2
# PROXY_NO_DATA_TIMEOUT_CHECKS=30
# PROXY_NO_DATA_CHECK_INTERVAL=0.1

# Stats collector
# COLLECT_INTERVAL_S controls how often stat URLs are checked for all active streams
# This is the PRIMARY mechanism for detecting stale streams (default: 1s for quick detection and livepos updates)
COLLECT_INTERVAL_S=1
STATS_HISTORY_MAX=720

# Reliability & Monitoring (NEW)
MONITOR_INTERVAL_S=10
ENGINE_GRACE_PERIOD_S=30
AUTOSCALE_INTERVAL_S=30

# Health Management Configuration
# Controls how the orchestrator monitors and replaces unhealthy engines
# HEALTH_CHECK_INTERVAL_S=20             # How often to check engine health (default: 20s)
# HEALTH_FAILURE_THRESHOLD=3             # Number of consecutive failures before marking unhealthy (default: 3)
# HEALTH_UNHEALTHY_GRACE_PERIOD_S=60     # Grace period before replacing unhealthy engines (default: 60s)
# HEALTH_REPLACEMENT_COOLDOWN_S=60       # Cooldown between replacements (default: 60s)

# Circuit Breaker Configuration
# Protects against cascading failures during provisioning issues
# CIRCUIT_BREAKER_FAILURE_THRESHOLD=5    # Failures before opening circuit (default: 5)
# CIRCUIT_BREAKER_RECOVERY_TIMEOUT_S=300 # Time before attempting recovery (default: 300s / 5min)
# CIRCUIT_BREAKER_REPLACEMENT_THRESHOLD=3   # Failed replacements before circuit opens (default: 3)
# CIRCUIT_BREAKER_REPLACEMENT_TIMEOUT_S=180 # Timeout for replacement circuit (default: 180s / 3min)

# Gluetun VPN Integration
# Uncomment and configure to enable VPN integration
# See docs/GLUETUN_INTEGRATION.md for comprehensive setup guide
# See docker-compose.gluetun.yml for single VPN mode example
# See docker-compose.gluetun-redundant.yml for redundant VPN mode example

# VPN Mode: single (one VPN) or redundant (two VPNs for high availability)
# VPN_MODE=single

# Single VPN Mode Configuration:
# GLUETUN_CONTAINER_NAME=gluetun
# GLUETUN_API_PORT=8001  # Internal port for Gluetun HTTP control server (must match HTTP_CONTROL_SERVER_ADDRESS in Gluetun)

# Redundant VPN Mode Configuration:
# VPN_MODE=redundant
# GLUETUN_CONTAINER_NAME=gluetun
# GLUETUN_CONTAINER_NAME_2=gluetun2
# GLUETUN_API_PORT=8001
# GLUETUN_PORT_RANGE_1=19000-19499  # Port range for first VPN (must match docker-compose port mapping)
# GLUETUN_PORT_RANGE_2=19500-19999  # Port range for second VPN (must match docker-compose port mapping)

# VPN Health and Recovery Settings:
# GLUETUN_HEALTH_CHECK_INTERVAL_S=5         # How often to check VPN health (default: 5s)
# GLUETUN_PORT_CACHE_TTL_S=60               # How long to cache forwarded port info (default: 60s)
# VPN_RESTART_ENGINES_ON_RECONNECT=true     # Restart engines when VPN reconnects (default: true)
# VPN_UNHEALTHY_RESTART_TIMEOUT_S=60        # Force restart VPN container after being unhealthy (default: 60s)

# Performance Optimization (NEW)
MAX_CONCURRENT_PROVISIONS=5
MIN_PROVISION_INTERVAL_S=0.5

# Acexy Integration Settings
# ACEXY_MAX_STREAMS_PER_ENGINE controls how many streams can be assigned to each engine
# The autoscaler will provision a new engine only when all engines have at least (ACEXY_MAX_STREAMS_PER_ENGINE - 1) streams
ACEXY_MAX_STREAMS_PER_ENGINE=3

# Dynamic ports
PORT_RANGE_HOST=19000-19999
ACE_HTTP_RANGE=40000-44999
ACE_HTTPS_RANGE=45000-49999
ACE_MAP_HTTPS=false

# Engine resource limits
# ENGINE_MEMORY_LIMIT=512m  # Optional: Set Docker memory limit for engine containers (e.g., 512m, 2g, 1024m)

# Security
API_KEY=defaultpassword

# Persistence
DB_URL=sqlite:///./orchestrator.db

# Auto-delete container when stream ends
AUTO_DELETE=true

# Other
TZ=Europe/Madrid
ENGINE_VARIANT=krinkuto11-amd64

# Engine Variant Versions (for ARM architectures)
# ENGINE_ARM32_VERSION=arm32-v3.2.13
# ENGINE_ARM64_VERSION=arm64-v3.2.13

# Debug Mode
DEBUG_MODE=false

# Stream Loop Detection
# Automatically detect and stop streams that are looping (no new data being fed)
# STREAM_LOOP_DETECTION_ENABLED=false
# STREAM_LOOP_DETECTION_THRESHOLD_S=3600  # Threshold in seconds (default: 1 hour)
# STREAM_LOOP_CHECK_INTERVAL_S=10  # How often to check for looping streams (default: 10 seconds)
# STREAM_LOOP_RETENTION_MINUTES=0  # How long to keep looping stream IDs (0 = indefinite, default: 0)

# Proxy Mode Configuration
# Options: lightweight (direct pipe) or ffmpeg (with transcoding passthrough and metadata extraction)
# lightweight: Simple piping from playback URL to clients (minimal overhead)
# ffmpeg: Uses FFmpeg passthrough for stream compatibility and extracts metadata (resolution, fps, codec)
PROXY_MODE=lightweight
